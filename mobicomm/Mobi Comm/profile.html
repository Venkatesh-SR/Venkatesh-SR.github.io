<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="icon" href="assets/logo plain.png" type="image/x-icon" />
    <link rel="stylesheet" href="../css/main.min.css" />
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <header>
      <nav
        class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top mb-5"
      >
        <div class="container-fluid">
          <!-- Logo & Brand Name -->
          <a
            href="main.html"
            class="navbar-brand fw-bold text-white d-flex align-items-center"
          >
            <img
              src="assets/logo plain.png"
              alt="Logo"
              width="50"
              height="30"
              class="me-2"
            />
            MOBI COMM
          </a>
          <!-- Navbar Toggle Button -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarScroll"
            aria-controls="navbarScroll"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <!-- Navbar Links & Icons -->
          <div class="collapse navbar-collapse" id="navbarScroll">
            <ul class="navbar-nav nav-underline me-auto">
              <li class="nav-item">
                <a class="nav-link text-white" href="main.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="plans.html">Plans</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="about.html">About Us</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="help.html">Help</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active text-white" href="profile.html"
                  >Profile</a
                >
              </li>
            </ul>
            <!-- Right Side Icons -->
            <div class="d-flex align-items-center">
              <!-- Notification Icon -->
              <a
                href="#"
                class="text-white me-3 position-relative"
                data-bs-toggle="modal"
                data-bs-target="#notificationModal"
              >
                <i class="fa-solid fa-bell fa-lg"></i>
                <span
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                >
                  3
                </span>
              </a>
              <!-- Profile Dropdown -->
              <div class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle text-white"
                  href="#"
                  role="button"
                  data-bs-toggle="dropdown"
                >
                  <i class="fa-solid fa-circle-user fa-lg"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="profile.html">My Profile</a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a
                      class="dropdown-item text-danger"
                      href="#"
                      data-bs-toggle="modal"
                      data-bs-target="#logoutModal"
                      >Logout</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Notification Modal -->
    <div
      class="modal fade"
      id="notificationModal"
      tabindex="-1"
      aria-labelledby="notificationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationModalLabel">
              Recharge Reminder
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Don't forget to recharge your account to continue enjoying
              uninterrupted services!
            </p>
          </div>
          <div class="modal-body">
            <p>Don't miss the exciting offers!</p>
          </div>
          <div class="modal-body">
            <p>Check out the latest offers!</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Okay, Got It
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal fade"
      id="logoutModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="logoutModalLabel">
              Logout Confirmation
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Are you sure you want to log out?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-bs-dismiss="modal"
            >
              Stay
            </button>
            <button type="button" class="btn btn-danger" onclick="logout()">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <br /><br />
    <!-- Main Profile Content -->
    <main>
      <div class="container mt-5">
        <h2 class="text-center mb-4">User Profile</h2>

        <!-- Profile Card -->
        <div class="card" id="profileCard">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center">
                <img
                  src="assets/avatar.webp"
                  alt="User Avatar"
                  class="img-fluid rounded-circle"
                  width="150"
                />
              </div>
              <div class="col-md-8">
                <h4 id="user-name">Loading...</h4>
                <p>
                  <strong>Email:</strong>
                  <span id="user-email">Loading...</span>
                </p>
                <p>
                  <strong>Phone:</strong>
                  <span id="user-phone">Loading...</span>
                </p>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#editProfileModal"
                >
                  Edit email
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Recharge History -->
        <div class="mt-4">
          <h4>Recharge History</h4>
          <table class="table table-bordered text-center">
            <thead class="table-primary">
              <tr>
                <th>Plan</th>
                <th>Amount</th>
                <th>Validity</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="recharge-history">
              <!-- Recharge history will be loaded dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Edit Profile Modal -->
      <div
        class="modal fade"
        id="editProfileModal"
        tabindex="-1"
        aria-labelledby="editProfileModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editProfileModalLabel">
                Edit Profile
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="edit-profile-form">
                <div class="mb-3">
                  <label for="edit-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="edit-email" />
                </div>
                <button type="submit" class="btn btn-success">
                  Save Changes
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white py-5 w-100 mt-5">
      <div class="container">
        <div class="row">
          <!-- Company Info -->
          <div class="col-md-4 mb-3">
            <h5>MOBI COMM</h5>
            <p>
              Stay connected with the best network provider. Fast, reliable, and
              always available.
            </p>
          </div>
          <!-- Quick Links -->
          <div class="col-md-2 mb-3">
            <h5>Quick Links</h5>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a href="main.html" class="nav-link p-0 text-white-50">Home</a>
              </li>
              <li class="nav-item">
                <a href="plans.html" class="nav-link p-0 text-white-50"
                  >Plans</a
                >
              </li>
              <li class="nav-item">
                <a href="about.html" class="nav-link p-0 text-white-50"
                  >About Us</a
                >
              </li>
              <li class="nav-item">
                <a href="help.html" class="nav-link p-0 text-white-50">Help</a>
              </li>
            </ul>
          </div>
          <!-- Support -->
          <div class="col-md-2 mb-3">
            <h5>Support</h5>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a href="#faq" class="nav-link p-0 text-white-50">FAQs</a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link p-0 text-white-50">Contact Us</a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link p-0 text-white-50"
                  >Terms &amp; Conditions</a
                >
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link p-0 text-white-50"
                  >Privacy Policy</a
                >
              </li>
            </ul>
          </div>
          <!-- Feedback Form -->
          <div class="col-lg-3 col-md-12 col-12 mb-3">
            <h5>Feedback</h5>
            <form>
              <div class="mb-2">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Your Name"
                  required
                />
              </div>
              <div class="mb-2">
                <input
                  type="email"
                  class="form-control"
                  placeholder="Your Email"
                  required
                />
              </div>
              <div class="mb-2">
                <textarea
                  class="form-control"
                  rows="2"
                  placeholder="Your Feedback"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary btn-sm w-100">
                Submit
              </button>
            </form>
          </div>
        </div>
        <hr class="border-white-50 my-4" />
        <div class="d-flex flex-column flex-sm-row justify-content-between">
          <p class="mb-0">© 2025 Mobi Comm. All Rights Reserved.</p>
          <ul class="list-unstyled d-flex gap-3">
            <li>
              <a
                href="https://www.facebook.com"
                target="blank"
                class="text-white-50 me-3"
                ><i class="fa-brands fa-facebook fs-2"></i
              ></a>
            </li>
            <li>
              <a
                href="https://www.twitter.com"
                target="blank"
                class="text-white-50 me-3"
                ><i class="fa-brands fa-twitter fs-2"></i
              ></a>
            </li>
            <li>
              <a
                href="https://www.instagram.com"
                target="blank"
                class="text-white-50 me-3"
                ><i class="fa-brands fa-instagram fs-2"></i
              ></a>
            </li>
            <li>
              <a
                href="https://www.linkedin.com"
                target="blank"
                class="text-white-50 me-3"
                ><i class="fa-brands fa-linkedin fs-2"></i
              ></a>
            </li>
            <li>
              <a
                href="https://www.youtube.com"
                target="blank"
                class="text-white-50 me-3"
                ><i class="fa-brands fa-youtube fs-2"></i
              ></a>
            </li>
          </ul>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JavaScript Function to Handle Logout -->
    <script>
      function logout() {
        window.location.href = "index.html"; // Redirect to login/home page after logout
      }
    </script>

    <!-- Dynamic Data: Fetch user, plan, and transaction info based on login mobile number -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Retrieve the mobile number saved in localStorage (set during login)
        const mobileNumber =
          localStorage.getItem("mobileNumber") || "9876543210";
        let plansData = {}; // To store plan details keyed by plan_id
        let currentUser = null; // To store the current user object

        // Fetch all plans data and store plan details (plan_name and validity)
        fetch("http://localhost:3001/plans")
          .then((response) => response.json())
          .then((plans) => {
            plansData = plans.reduce((acc, plan) => {
              acc[plan.plan_id] = {
                name: plan.plan_name,
                validity: plan.validity,
              };
              return acc;
            }, {});
          })
          .catch((error) => console.error("Error fetching plans data:", error));

        // Fetch user data based on mobile number.
        fetch(`http://localhost:3001/user?mobile=${mobileNumber}`)
          .then((response) => response.json())
          .then((users) => {
            if (users.length === 0) {
              console.error("User not found");
              return;
            }
            currentUser = users[0];
            document.getElementById("user-name").textContent =
              currentUser.name || "N/A";
            document.getElementById("user-email").textContent =
              currentUser.email || "N/A";
            document.getElementById("user-phone").textContent =
              currentUser.mobile || "N/A";
          })
          .catch((error) => console.error("Error fetching user data:", error));

        // Fetch transactions for this user.
        fetch("http://localhost:3001/transactions")
          .then((response) => response.json())
          .then((allTxns) => {
            const userTxns = allTxns.filter(
              (txn) => txn.mobile === mobileNumber
            );
            const tbody = document.getElementById("recharge-history");
            tbody.innerHTML = "";
            userTxns.forEach((txn) => {
              // Look up plan details using txn.plan_id
              const planDetail = plansData[txn.plan_id];
              const planName = planDetail ? planDetail.name : "N/A";
              const planValidity = planDetail ? planDetail.validity : "N/A";
              tbody.innerHTML += `
                <tr>
                  <td>${planName}</td>
                  <td>₹${txn.amount || "0"}</td>
                  <td>${planValidity}</td>
                  <td>${txn.date || "N/A"}</td>
                </tr>
              `;
            });
          })
          .catch((error) =>
            console.error("Error fetching transactions:", error)
          );

        // When the Edit Profile modal is shown, pre-fill the email input with the current user's email.
        var editModalEl = document.getElementById("editProfileModal");
        editModalEl.addEventListener("shown.bs.modal", function () {
          if (currentUser && currentUser.email) {
            document.getElementById("edit-email").value = currentUser.email;
          }
        });

        // Handle Edit Profile form submission (update user data)
        document
          .getElementById("edit-profile-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            if (!currentUser) return;
            // Confirm changes before saving
            if (!confirm("Are you sure you want to save changes?")) return;
            const updatedEmail = document.getElementById("edit-email").value;
            const updatedUser = { ...currentUser, email: updatedEmail };
            fetch(`http://localhost:3001/user/${currentUser.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedUser),
            })
              .then((response) => response.json())
              .then((data) => {
                currentUser = data;
                document.getElementById("user-email").textContent = data.email;
                // Close the modal
                new bootstrap.Modal(editModalEl).hide();
              })
              .catch((err) => console.error("Error updating user:", err));
          });
      });
    </script>
  </body>
</html>
